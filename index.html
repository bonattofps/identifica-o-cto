<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Identifica√ß√£o T√©cnica CTO | N2/N3</title>
<style>
  body { margin: 0; font-family: "Segoe UI", Arial, sans-serif; background: #0f172a; color: #e5e7eb; }
  .container { max-width: 1100px; margin: 40px auto; padding: 20px; }
  h1 { text-align: center; color: #3b82f6; margin-bottom: 30px; }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
  .form-group { display: flex; flex-direction: column; }
  .form-group label { font-size: 13px; margin-bottom: 6px; color: #9ca3af; }
  .form-group input, .form-group textarea { background: #111827; color: #e5e7eb; border: 1px solid #1f2933; border-radius: 6px; padding: 10px; }
  .full { grid-column: span 2; }
  .output textarea { width: 100%; min-height: 150px; background: #020617; border: 1px solid #1f2933; color: #e5e7eb; border-radius: 6px; padding: 12px; }
  .button-group { display: flex; gap: 10px; margin-top: 14px; }
  button { padding: 10px 22px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
  .btn-copy { background: #22c55e; color: #052e14; }
  .btn-save { background: #3b82f6; color: white; }
  .btn-foto { background: #64748b; color: white; margin-top: 8px; }
  .table-container { overflow-x: auto; margin-top: 30px; background: #111827; border-radius: 8px; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { background: #1e293b; color: #3b82f6; padding: 12px; border-bottom: 2px solid #1f2933; }
  td { padding: 12px; border-bottom: 1px solid #1f2933; text-align: center; }
  .preview-img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #3b82f6; }
</style>
</head>
<body>

<div class="container">
  <h1>Identifica√ß√£o T√©cnica de CTO ‚Äì N2 / N3</h1>

  <div class="form-grid">
    <div class="form-group"><label>OLT</label><input id="olt" type="text" placeholder="Ex: OLT-01"></div>
    <div class="form-group"><label>Slot / PON</label><input id="pon" type="text" placeholder="Ex: 0/1/2"></div>
    <div class="form-group"><label>T√©cnico de Campo</label><input id="tecnico" type="text" placeholder="Nome do t√©cnico"></div>
    <div class="form-group"><label>Suporte Respons√°vel (N2 / N3)</label><input id="suporte" type="text" placeholder="Seu nome"></div>
    <div class="form-group full"><label>Observa√ß√µes</label><textarea id="obs" placeholder="Detalhes do servi√ßo..."></textarea></div>
    
    <div class="form-group full">
      <label>Anexar Foto (Opcional)</label>
      <input type="file" id="inputFoto" accept="image/*" style="display:none" onchange="processarFoto()">
      <button class="btn-foto" onclick="document.getElementById('inputFoto').click()">üì∏ Selecionar Foto do Servi√ßo</button>
      <div id="nomeArquivo" style="color: #22c55e; font-size: 12px; margin-top: 5px; font-weight: bold;"></div>
    </div>
  </div>

  <div class="output" style="margin-top:20px;">
    <textarea id="saida" readonly></textarea>
    <div class="button-group">
        <button class="btn-copy" onclick="copiar()">Copiar Texto</button>
        <button class="btn-save" id="btnSalvar" onclick="salvarNoBanco()">Salvar no Hist√≥rico Global</button>
    </div>
  </div>

  <h2 style="color:#3b82f6; margin-top:40px;">Hist√≥rico de Registros (Rond√¥nia - RO)</h2>
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Data/Hora</th>
          <th>OLT</th>
          <th>Slot/PON</th>
          <th>T√©cnico</th>
          <th>Suporte</th>
          <th>Foto</th>
          <th>Observa√ß√µes</th>
        </tr>
      </thead>
      <tbody id="corpoHistorico">
        <tr><td colspan='7' style='text-align:center'>Carregando hist√≥rico...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxXfwkb331T9w1z5viqhqUjjPQhrLmykHmUrSd7rbhWTUV-6lQuha5qC1Y8XZx2uSaA4A/exec";
let imagemBase64 = "";

const campos = ["olt","pon","tecnico","suporte","obs"];
campos.forEach(id => document.getElementById(id).addEventListener("input", () => {
  const v = (i) => document.getElementById(i).value;
  document.getElementById("saida").value = `Identifica√ß√£o T√©cnica\n\nOLT: ${v('olt')}\nSLOT/PON: ${v('pon')}\nT√âCNICO: ${v('tecnico')}\nSUPORTE: ${v('suporte')}\nOBS: ${v('obs')}`;
}));

function processarFoto() {
  const file = document.getElementById('inputFoto').files[0];
  const reader = new FileReader();
  reader.onloadend = () => { 
    imagemBase64 = reader.result; 
    document.getElementById('nomeArquivo').innerText = "‚úÖ Foto pronta: " + file.name; 
  };
  if (file) reader.readAsDataURL(file);
}

function copiar() { 
  const area = document.getElementById("saida");
  area.select();
  document.execCommand("copy");
  alert("Texto copiado!"); 
}

async function salvarNoBanco() {
  const btn = document.getElementById("btnSalvar");
  const dados = { 
    olt: document.getElementById("olt").value, 
    pon: document.getElementById("pon").value, 
    tecnico: document.getElementById("tecnico").value, 
    suporte: document.getElementById("suporte").value, 
    obs: document.getElementById("obs").value, 
    imagem: imagemBase64 
  };
  
  if(!dados.olt || !dados.tecnico) return alert("Erro: Preencha pelo menos a OLT e o T√©cnico!");
  
  btn.innerText = "Enviando..."; 
  btn.disabled = true;
  
  try {
    await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(dados) });
    alert("Registro salvo com sucesso!"); 
    location.reload();
  } catch (e) { 
    alert("Erro ao salvar!"); 
    btn.disabled = false; 
    btn.innerText = "Salvar no Hist√≥rico Global";
  }
}

async function carregarHistorico() {
  const corpo = document.getElementById("corpoHistorico");
  try {
    const resp = await fetch(SCRIPT_URL);
    const registros = await response = await resp.json();
    corpo.innerHTML = "";
    
    registros.reverse().forEach(reg => {
      // Ordem Planilha: [0]Data, [1]OLT, [2]PON, [3]T√©cnico, [4]Suporte, [5]Obs, [6]Foto
      const row = `<tr>
        <td>${reg[0]}</td>
        <td>${reg[1]}</td>
        <td>${reg[2]}</td>
        <td>${reg[3]}</td>
        <td>${reg[4] || "N/A"}</td>
        <td>${reg[6] && reg[6].includes("http") ? `<a href="${reg[6]}" target="_blank"><img src="${reg[6]}" class="preview-img"></a>` : "Sem foto"}</td>
        <td>${reg[5]}</td>
      </tr>`;
      corpo.innerHTML += row;
    });
  } catch (e) { 
    corpo.innerHTML = "<tr><td colspan='7' style='text-align:center'>Nenhum registro encontrado.</td></tr>"; 
  }
}

window.onload = carregarHistorico;
</script>
</body>
</html>

