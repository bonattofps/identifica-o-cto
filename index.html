<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Identifica√ß√£o T√©cnica CTO | N2/N3</title>

<style>
  /* --- ESTILO GERAL (Tema Escuro Profissional) --- */
  body { margin: 0; font-family: "Segoe UI", Arial, sans-serif; background: #0f172a; color: #e5e7eb; }
  .container { max-width: 1200px; margin: 40px auto; padding: 20px; }
  
  h1 { text-align: center; color: #3b82f6; margin-bottom: 30px; font-weight: 700; letter-spacing: 0.5px; }
  h2 { color: #3b82f6; font-size: 1.1rem; margin-top: 50px; border-bottom: 1px solid #1e293b; padding-bottom: 15px; }

  /* --- FORMUL√ÅRIO --- */
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .form-group { display: flex; flex-direction: column; }
  .full-width { grid-column: span 2; }

  label { font-size: 13px; margin-bottom: 8px; color: #94a3b8; font-weight: 500; }
  
  input, textarea { 
    background: #1e293b; color: #f8fafc; border: 1px solid #334155; 
    border-radius: 6px; padding: 12px; font-size: 14px; transition: 0.2s; 
  }
  input:focus, textarea:focus { outline: none; border-color: #3b82f6; background: #252f42; }
  textarea { resize: vertical; min-height: 80px; }

  /* --- BOT√ÉO DE FOTO --- */
  .btn-foto { 
    background: #334155; color: #e2e8f0; display: flex; align-items: center; justify-content: center; 
    gap: 10px; width: 100%; padding: 15px; border-radius: 6px; cursor: pointer; border: 2px dashed #475569;
    transition: 0.2s;
  }
  .btn-foto:hover { background: #1e293b; border-color: #3b82f6; color: #3b82f6; }
  #statusFoto { font-size: 13px; color: #22c55e; margin-top: 8px; font-weight: bold; text-align: center; min-height: 20px;}

  /* --- √ÅREA DE SA√çDA E A√á√ïES --- */
  .output-area { margin-top: 30px; background: #1e293b; padding: 25px; border-radius: 8px; border: 1px solid #334155; }
  .output-area textarea { width: 100%; background: #0f172a; border: none; min-height: 120px; box-sizing: border-box; font-family: monospace; }

  .action-buttons { display: flex; gap: 15px; margin-top: 20px; }
  button { padding: 12px 24px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 14px; flex: 1; }
  
  .btn-copy { background: #22c55e; color: #022c22; }
  .btn-copy:hover { background: #16a34a; }
  
  .btn-save { background: #3b82f6; color: white; }
  .btn-save:hover { background: #2563eb; }
  .btn-save:disabled { background: #64748b; cursor: not-allowed; opacity: 0.7; }

  /* --- TABELA DE HIST√ìRICO --- */
  .table-wrapper { overflow-x: auto; margin-top: 20px; border-radius: 8px; border: 1px solid #334155; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
  table { width: 100%; border-collapse: collapse; font-size: 13px; text-align: left; background: #1e293b; }
  
  th { background: #0f172a; color: #3b82f6; padding: 16px; border-bottom: 2px solid #334155; white-space: nowrap; font-weight: 600; }
  td { padding: 12px 16px; border-bottom: 1px solid #334155; vertical-align: middle; color: #cbd5e1; }
  tr:last-child td { border-bottom: none; }
  tr:hover { background: #263345; }

  .thumb-img { 
    width: 45px; height: 45px; object-fit: cover; border-radius: 6px; border: 1px solid #475569; 
    transition: transform 0.2s; cursor: pointer; background: #0f172a;
  }
  .thumb-img:hover { transform: scale(3.5); border-color: #3b82f6; z-index: 50; position: relative; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); }

  footer { margin-top: 60px; text-align: center; font-size: 12px; color: #64748b; padding-bottom: 20px; }

  /* Responsivo para celular */
  @media (max-width: 600px) {
    .form-grid { grid-template-columns: 1fr; }
    .full-width { grid-column: span 1; }
  }
</style>
</head>

<body>

<div class="container">
  <h1>IDENTIFICA√á√ÉO T√âCNICA CTO</h1>

  <div class="form-grid">
    <div class="form-group">
      <label>OLT</label>
      <input id="olt" type="text" placeholder="Ex: GIGA-JAW-LIB-COA">
    </div>

    <div class="form-group">
      <label>Slot / PON</label>
      <input id="pon" type="text" placeholder="Ex: 0-0-13-6">
    </div>

    <div class="form-group">
      <label>T√©cnico de Campo</label>
      <input id="tecnico" type="text" placeholder="Nome do t√©cnico">
    </div>

    <div class="form-group">
      <label>Suporte Respons√°vel</label>
      <input id="suporte" type="text" placeholder="Seu nome">
    </div>

    <div class="form-group full-width">
      <label>Foto do Servi√ßo (Opcional)</label>
      <input type="file" id="inputFoto" accept="image/*" style="display:none" onchange="prepararFoto()">
      <div class="btn-foto" onclick="document.getElementById('inputFoto').click()">
        üì∑ Clique aqui para anexar a foto
      </div>
      <div id="statusFoto"></div>
    </div>

    <div class="form-group full-width">
      <label>Observa√ß√µes</label>
      <textarea id="obs" placeholder="Descreva o servi√ßo, sinal ou testes realizados..."></textarea>
    </div>
  </div>

  <div class="output-area">
    <label style="color: #3b82f6; font-weight: bold;">Texto Gerado para Copiar</label>
    <textarea id="saida" readonly></textarea>
    
    <div class="action-buttons">
      <button class="btn-copy" onclick="copiarTexto()">Copiar Texto</button>
      <button class="btn-save" id="btnSalvar" onclick="enviarDados()">Salvar no Hist√≥rico</button>
    </div>
  </div>

  <h2>Hist√≥rico de Atendimentos (Rond√¥nia - GMT-4)</h2>
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Data/Hora</th>
          <th>OLT</th>
          <th>Slot/PON</th>
          <th>T√©cnico</th>
          <th>Suporte</th>
          <th>Foto</th>
          <th>Observa√ß√µes</th>
        </tr>
      </thead>
      <tbody id="listaHistorico">
        <tr><td colspan="7" style="text-align:center; padding: 25px; color: #94a3b8;">Carregando registros...</td></tr>
      </tbody>
    </table>
  </div>

  <footer>Sistema de Apoio N2/N3 - Desenvolvido by Juander</footer>
</div>

<script>
// --- SEU LINK DO GOOGLE APPS SCRIPT ---
const API_URL = "https://script.google.com/macros/s/AKfycbxXfwkb331T9w1z5viqhqUjjPQhrLmykHmUrSd7rbhWTUV-6lQuha5qC1Y8XZx2uSaA4A/exec";

let imagemBase64 = "";

// Gera o texto automaticamente ao digitar
const ids = ["olt", "pon", "tecnico", "suporte", "obs"];
ids.forEach(id => document.getElementById(id).addEventListener("input", gerarTexto));

function gerarTexto() {
  const v = (id) => document.getElementById(id).value || "...";
  const texto = `Identifica√ß√£o T√©cnica\n\nOLT: ${v('olt')}\nSLOT / PON: ${v('pon')}\nT√âCNICO DE CAMPO: ${v('tecnico')}\nSUPORTE RESPONS√ÅVEL: ${v('suporte')}\nOBSERVA√á√ïES: ${v('obs')}`;
  document.getElementById("saida").value = texto;
}

function copiarTexto() {
  const area = document.getElementById("saida");
  area.select();
  document.execCommand("copy");
  alert("Texto copiado!");
}

function prepararFoto() {
  const arquivo = document.getElementById('inputFoto').files[0];
  if (arquivo) {
    const leitor = new FileReader();
    leitor.onloadend = function() {
      imagemBase64 = leitor.result;
      document.getElementById('statusFoto').innerText = "‚úÖ Imagem selecionada: " + arquivo.name;
    }
    leitor.readAsDataURL(arquivo);
  }
}

async function enviarDados() {
  const btn = document.getElementById("btnSalvar");
  
  const payload = {
    olt: document.getElementById("olt").value,
    pon: document.getElementById("pon").value,
    tecnico: document.getElementById("tecnico").value,
    suporte: document.getElementById("suporte").value,
    obs: document.getElementById("obs").value,
    imagem: imagemBase64
  };

  if (!payload.olt || !payload.tecnico) {
    alert("Erro: Preencha pelo menos a OLT e o T√©cnico.");
    return;
  }

  btn.innerText = "Enviando...";
  btn.disabled = true;

  try {
    // Envia os dados para a planilha
    await fetch(API_URL, {
      method: 'POST',
      mode: 'no-cors',
      body: JSON.stringify(payload)
    });
    
    alert("Salvo com sucesso!");
    location.reload(); // Recarrega para mostrar a foto nova na tabela
  } catch (erro) {
    console.error(erro);
    alert("Erro ao salvar. Verifique sua conex√£o.");
    btn.disabled = false;
    btn.innerText = "Salvar no Hist√≥rico";
  }
}

async function carregarTabela() {
  const tabela = document.getElementById("listaHistorico");
  
  try {
    const resposta = await fetch(API_URL);
    const dados = await resposta.json();
    
    tabela.innerHTML = ""; // Limpa o carregando
    
    // Inverte a ordem para mostrar os mais recentes primeiro
    dados.reverse().forEach(linha => {
      // Mapeia as colunas conforme a ordem que definimos no Script do Google
      // [0]Data, [1]OLT, [2]PON, [3]T√©cnico, [4]Suporte, [5]Obs, [6]Foto
      
      const linkFoto = linha[6];
      let celulaFoto = '<span style="color:#64748b; font-size:11px;">Sem foto</span>';
      
      // Se tiver link de foto v√°lido, cria a miniatura
      if (linkFoto && linkFoto.includes("http")) {
        celulaFoto = `<a href="${linkFoto}" target="_blank"><img src="${linkFoto}" class="thumb-img" title="Clique para ampliar"></a>`;
      }

      const htmlLinha = `
        <tr>
          <td>${linha[0]}</td>
          <td>${linha[1]}</td>
          <td>${linha[2]}</td>
          <td>${linha[3]}</td>
          <td>${linha[4]}</td>
          <td style="text-align:center">${celulaFoto}</td>
          <td>${linha[5]}</td>
        </tr>
      `;
      tabela.innerHTML += htmlLinha;
    });
    
  } catch (erro) {
    tabela.innerHTML = `<tr><td colspan="7" style="text-align:center; color: #ef4444;">Nenhum registro encontrado ou erro na conex√£o.</td></tr>`;
  }
}

// Inicia o carregamento assim que abrir a p√°gina
window.onload = carregarTabela;
</script>

</body>
</html>
