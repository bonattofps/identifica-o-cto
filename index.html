<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Identifica√ß√£o T√©cnica CTO</title>
<style>
  /* --- TEMA DARK NAVY (VISUAL APROVADO) --- */
  :root {
    --bg-color: #0b1120;       /* Fundo muito escuro */
    --card-bg: #151e32;        /* Card azul navy */
    --input-bg: #1e293b;       /* Inputs */
    --accent: #3b82f6;         /* Azul destaque */
    --accent-hover: #2563eb;
    --text-main: #e2e8f0;
    --text-muted: #94a3b8;
    --border: #334155;
  }

  body { margin: 0; font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-color); color: var(--text-main); }
  .container { max-width: 1000px; margin: 40px auto; padding: 20px; }

  /* T√≠tulo */
  h1 { 
    text-align: center; color: var(--accent); margin-bottom: 30px; 
    font-weight: 800; text-transform: uppercase; letter-spacing: 1px;
    border-bottom: 2px solid var(--accent); display: inline-block; padding-bottom: 10px;
  }
  .header-center { text-align: center; width: 100%; }

  /* Grid e Inputs */
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .form-group { display: flex; flex-direction: column; }
  .full { grid-column: span 2; }
  
  label { font-size: 13px; margin-bottom: 8px; color: var(--text-muted); font-weight: 600; }
  
  input, textarea {
    background: var(--input-bg); color: white; border: 1px solid var(--border);
    border-radius: 6px; padding: 12px; font-size: 14px; outline: none; transition: 0.2s;
  }
  input:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
  textarea { resize: vertical; min-height: 100px; }

  /* Bot√£o de Foto Especial */
  .upload-area {
    border: 2px dashed var(--border); background: rgba(30, 41, 59, 0.5);
    padding: 25px; text-align: center; border-radius: 8px; cursor: pointer;
    transition: 0.2s; position: relative;
  }
  .upload-area:hover { border-color: var(--accent); background: rgba(59, 130, 246, 0.05); }
  .upload-icon { font-size: 24px; margin-bottom: 8px; display: block; }
  .upload-text { font-weight: 600; color: var(--text-muted); }
  .upload-area:hover .upload-text { color: var(--accent); }
  #inputFoto { display: none; }
  #previewStatus { margin-top: 10px; font-size: 13px; font-weight: bold; color: #22c55e; min-height: 20px; text-align: center;}

  /* √Årea de Texto Gerado */
  .output-box {
    margin-top: 30px; background: #020617; border: 1px solid var(--border);
    border-radius: 8px; padding: 20px;
  }
  .output-textarea {
    width: 100%; min-height: 120px; background: transparent; border: none;
    color: #e2e8f0; font-family: monospace; resize: none; outline: none;
  }

  /* Bot√µes */
  .btn-group { display: flex; gap: 15px; margin-top: 15px; }
  button {
    padding: 14px; border: none; border-radius: 6px; font-weight: 700; 
    cursor: pointer; flex: 1; color: white; text-transform: uppercase; font-size: 14px;
    transition: 0.2s;
  }
  .btn-copy { background: #10b981; color: #022c22; }
  .btn-copy:hover { background: #059669; color: white; }
  
  .btn-save { background: var(--accent); }
  .btn-save:hover { background: var(--accent-hover); }
  .btn-save:disabled { background: #475569; cursor: wait; opacity: 0.7; }

  /* Tabela */
  h2 { color: var(--accent); margin-top: 50px; border-bottom: 1px solid var(--border); padding-bottom: 10px; font-size: 18px; }
  .table-responsive { overflow-x: auto; margin-top: 20px; border-radius: 8px; border: 1px solid var(--border); }
  table { width: 100%; border-collapse: collapse; font-size: 13px; background: var(--card-bg); white-space: nowrap; }
  
  th { text-align: left; color: var(--accent); padding: 15px; border-bottom: 2px solid var(--border); background: #0f172a; }
  td { padding: 12px 15px; border-bottom: 1px solid var(--border); color: var(--text-muted); vertical-align: middle; }
  tr:hover { background: #1e293b; }

  .thumb { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid #64748b; cursor: pointer; background: #000; }
  .thumb:hover { transform: scale(3.5); position: relative; z-index: 100; border-color: var(--accent); box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
  
  footer { margin-top: 50px; text-align: center; color: #64748b; font-size: 12px; padding-bottom: 30px; }

  @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } .full { grid-column: span 1; } .btn-group { flex-direction: column; } }
</style>
</head>
<body>

<div class="container">
  <div class="header-center"><h1>IDENTIFICA√á√ÉO T√âCNICA CTO</h1></div>

  <div class="form-grid">
    <div class="form-group"><label>OLT</label><input id="olt" type="text" placeholder="Ex: GIGA-JAW-LIB-COA"></div>
    <div class="form-group"><label>Slot / PON</label><input id="pon" type="text" placeholder="Ex: 0-0-13-6"></div>
    <div class="form-group"><label>T√©cnico de Campo</label><input id="tecnico" type="text" placeholder="Nome do T√©cnico"></div>
    <div class="form-group"><label>Suporte Respons√°vel</label><input id="suporte" type="text" placeholder="Seu Nome"></div>

    <div class="full">
      <label>Foto do Servi√ßo (Obrigat√≥rio / Opcional)</label>
      <label class="upload-area">
        <span class="upload-icon">üì∑</span>
        <span class="upload-text">Toque aqui para anexar a foto</span>
        <input type="file" id="inputFoto" accept="image/*" onchange="processarFoto()">
      </label>
      <div id="previewStatus"></div>
    </div>

    <div class="full"><label>Observa√ß√µes</label><textarea id="obs" placeholder="Descreva o servi√ßo realizado..."></textarea></div>
  </div>

  <div class="output-box">
    <label style="color:#3b82f6; font-size:13px; font-weight:bold; margin-bottom:10px; display:block;">TEXTO GERADO (WhatsApp/Sistema)</label>
    <textarea id="saida" class="output-textarea" readonly></textarea>
    <div class="btn-group">
      <button class="btn-copy" onclick="copiar()">COPIAR TEXTO</button>
      <button class="btn-save" id="btnSalvar" onclick="salvar()">SALVAR NO HIST√ìRICO</button>
    </div>
  </div>

  <h2>Hist√≥rico de Atendimentos (Rond√¥nia GMT-4)</h2>
  <div class="table-responsive">
    <table id="tabelaHistorico">
      <thead><tr><th>Data/Hora</th><th>OLT</th><th>PON</th><th>T√©cnico</th><th>Suporte</th><th>Foto</th><th>Obs</th></tr></thead>
      <tbody id="listaHistorico"><tr><td colspan="7" style="text-align:center; padding:20px;">Carregando hist√≥rico...</td></tr></tbody>
    </table>
  </div>
  
  <footer>Sistema de Apoio N2/N3 - Desenvolvido by Juander</footer>
</div>

<script>
// ==============================================================
// COLE SUA URL NOVA DO APPS SCRIPT AQUI DENTRO DAS ASPAS:
const API_URL = "https://script.google.com/macros/s/AKfycbxXfwkb331T9w1z5viqhqUjjPQhrLmykHmUrSd7rbhWTUV-6lQuha5qC1Y8XZx2uSaA4A/exec";
// ==============================================================

let imagemBase64 = "";

// GERA O TEXTO AUTOMATICAMENTE
const ids = ["olt","pon","tecnico","suporte","obs"];
ids.forEach(id => document.getElementById(id).addEventListener("input", gerarTexto));

function gerarTexto() {
  const v = (id) => document.getElementById(id).value || "...";
  document.getElementById("saida").value = 
`Identifica√ß√£o T√©cnica

OLT: ${v('olt').toUpperCase()}
SLOT/PON: ${v('pon')}
T√âCNICO: ${v('tecnico')}
SUPORTE: ${v('suporte')}
OBS: ${v('obs')}`;
}

// 1. COMPRESSOR DE FOTO (IMPEDE QUE A FOTO SEJA PESADA DEMAIS)
function processarFoto() {
  const file = document.getElementById('inputFoto').files[0];
  if(!file) return;

  document.getElementById('previewStatus').innerText = "‚è≥ Preparando imagem...";
  
  const reader = new FileReader();
  reader.readAsDataURL(file);
  reader.onload = function(event) {
    const img = new Image();
    img.src = event.target.result;
    img.onload = function() {
      const canvas = document.createElement('canvas');
      const MAX_WIDTH = 800; // Largura m√°xima segura
      const scaleSize = MAX_WIDTH / img.width;
      canvas.width = MAX_WIDTH;
      canvas.height = img.height * scaleSize;

      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      
      // Converte para JPG leve (0.7 qualidade)
      imagemBase64 = canvas.toDataURL('image/jpeg', 0.7);
      document.getElementById('previewStatus').innerText = "‚úÖ Foto pronta: " + file.name;
    }
  }
}

function copiar() {
  document.getElementById("saida").select();
  document.execCommand("copy");
  alert("Texto copiado!");
}

async function salvar() {
  const btn = document.getElementById("btnSalvar");
  const olt = document.getElementById("olt").value;
  const tecnico = document.getElementById("tecnico").value;

  if(!olt || !tecnico) return alert("Erro: Preencha OLT e T√©cnico!");
  
  // Impede envio se a foto foi selecionada mas ainda n√£o processou
  const fileInput = document.getElementById('inputFoto');
  if(fileInput.files.length > 0 && imagemBase64 === "") {
    return alert("Aguarde o processamento da foto...");
  }

  btn.innerText = "ENVIANDO...";
  btn.disabled = true;

  const dados = {
    olt: olt,
    pon: document.getElementById("pon").value,
    tecnico: tecnico,
    suporte: document.getElementById("suporte").value,
    obs: document.getElementById("obs").value,
    imagem: imagemBase64 // Envia a vers√£o leve
  };

  try {
    await fetch(API_URL, {
      method: "POST",
      mode: "no-cors",
      body: JSON.stringify(dados)
    });
    alert("Salvo com sucesso!");
    location.reload();
  } catch (error) {
    alert("Erro ao salvar: " + error);
    btn.disabled = false;
    btn.innerText = "SALVAR NO HIST√ìRICO";
  }
}

// 2. CARREGAR TABELA (COM CORRE√á√ÉO DE DATA ISO)
async function carregar() {
  const tbody = document.getElementById("listaHistorico");
  try {
    // ?t= for√ßa atualiza√ß√£o imediata
    const response = await fetch(API_URL + "?t=" + new Date().getTime());
    const dados = await response.json();
    tbody.innerHTML = "";

    if (dados.length === 0) {
      tbody.innerHTML = "<tr><td colspan='7' style='text-align:center'>Nenhum registro.</td></tr>";
      return;
    }

    dados.reverse().forEach(row => {
      // Remove o ' e converte data ISO estranha para leg√≠vel se necess√°rio
      let dataF = row[0] ? row[0].toString().replace(/^'/, "") : "-";
      
      // Se ainda vier como ISO (2026-01...), tenta limpar visualmente
      if(dataF.includes("T")) {
         dataF = dataF.split("T")[0].split("-").reverse().join("/") + " " + dataF.split("T")[1].slice(0,5);
      }

      const ponF = row[2] ? row[2].toString().replace(/^'/, "") : "-";
      
      let linkHtml = '<span style="color:#64748b">-</span>';
      if (row[5] && row[5].includes("http")) {
        linkHtml = `<a href="${row[5]}" target="_blank"><img src="${row[5]}" class="thumb" title="Ver foto"></a>`;
      }

      tbody.innerHTML += `<tr>
        <td>${dataF}</td>
        <td>${row[1]}</td>
        <td>${ponF}</td>
        <td>${row[3]}</td>
        <td>${row[4]}</td>
        <td style="text-align:center">${linkHtml}</td>
        <td style="white-space:normal; max-width:250px;">${row[6]}</td>
      </tr>`;
    });
  } catch (e) {
    console.error(e);
    tbody.innerHTML = "<tr><td colspan='7' style='text-align:center; color:#ef4444'>Erro ao carregar tabela.</td></tr>";
  }
}

window.onload = carregar;
</script>
</body>
</html>
